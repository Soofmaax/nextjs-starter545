name: CI Complete

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  code-quality:
    name: Code Quality (lint + typecheck)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm

      - name: Install dependencies
        run: npm install

      - name: Lint (ESLint + Next.js)
        run: npm run lint

      - name: Typecheck (TypeScript)
        run: npm run typecheck

  code-consistency:
    name: Code Consistency Checks
    runs-on: ubuntu-latest
    needs: code-quality

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check forbidden Tailwind colors (amber-*)
        run: |
          if git grep -n "amber-" -- 'src' ; then
            echo "❌ Tailwind amber-* classes found in src/. Design system requires slate-* only."
            exit 1
          else
            echo "✅ No amber-* classes found in src/"
          fi

      - name: Check forbidden files (EN layout + root image)
        run: |
          if [ -f "Sarah Temple-Boyer.jpg" ]; then
            echo "❌ Forbidden image file at repo root: Sarah Temple-Boyer.jpg"
            exit 1
          fi

          if [ -f "src/app/en/layout.tsx" ]; then
            echo "❌ Forbidden file: src/app/en/layout.tsx (EN uses global layout.tsx only)"
            exit 1
          fi

          echo "✅ Forbidden files not present"

      - name: Check console.log / debugger in production code
        run: |
          if git grep -n -E "console\\.log|debugger" -- 'src' ; then
            echo "❌ console.log or debugger statements found in src/. Please remove or guard them."
            exit 1
          else
            echo "✅ No console.log / debugger in src/"
          fi

      - name: Check TODO / FIXME comments
        run: |
          if git grep -n -E "TODO|FIXME" -- 'src' ; then
            echo "❌ TODO/FIXME comments found in src/. Track them in docs/TODO.md or issues, then remove."
            exit 1
          else
            echo "✅ No TODO/FIXME found in src/"
          fi

  format-check:
    name: Prettier Format Check
    runs-on: ubuntu-latest
    needs: code-quality

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm

      - name: Install dependencies
        run: npm install

      - name: Run Prettier (check only)
        run: npm run format:check

  security-audit:
    name: Security Audit (npm audit)
    runs-on: ubuntu-latest
    needs: code-quality

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm

      - name: Install dependencies
        run: npm install

      - name: npm audit (all dependencies)
        run: npm audit --audit-level=high

      - name: npm audit (production only)
        run: npm audit --production --audit-level=high

  build:
    name: Production Build & Bundle Size
    runs-on: ubuntu-latest
    needs: code-quality

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm

      - name: Install dependencies
        run: npm install

      - name: Build Next.js app
        run: npm run build

      - name: Cache Next.js build artifacts
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: next-cache-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: Show .next size
        run: du -sh .next || true

  seo-links:
    name: Internal Links & Sitemap Check
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm

      - name: Install dependencies
        run: npm install

      - name: Build Next.js app
        run: npm run build

      - name: Start Next.js in background
        run: |
          npm run start -- --port 3000 &>/dev/null &
          sleep 30

      - name: Check sitemap and robots
        run: |
          curl -f http://localhost:3000/sitemap.xml
          curl -f http://localhost:3000/robots.txt

      - name: Check links with linkinator
        run: npx linkinator http://localhost:3000 --recurse --timeout 10000

  a11y:
    name: Accessibility Audit
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm

      - name: Install dependencies
        run: npm install

      - name: Build Next.js app
        run: npm run build

      - name: Start Next.js in background
        run: |
          npm run start -- --port 3000 &>/dev/null &
          sleep 30

      - name: Run pa11y on key pages
        run: |
          npx pa11y http://localhost:3000/
          npx pa11y http://localhost:3000/en
          npx pa11y http://localhost:3000/blog
          npx pa11y http://localhost:3000/contact

  sanity-schema:
    name: Sanity Schema Validation
    runs-on: ubuntu-latest
    needs: code-quality

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm

      - name: Install dependencies
        run: npm install

      - name: Validate Sanity schema
        run: npx sanity check --root=./sanity

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs:
      - code-quality
      - code-consistency
      - format-check
      - security-audit
      - build
      - seo-links
      - a11y
      - sanity-schema
    if: always()

    steps:
      - name: Print job results
        run: |
          echo "code-quality: ${{ needs.code-quality.result }}"
          echo "code-consistency: ${{ needs.code-consistency.result }}"
          echo "format-check: ${{ needs.format-check.result }}"
          echo "security-audit: ${{ needs.security-audit.result }}"
          echo "build: ${{ needs.build.result }}"
          echo "seo-links: ${{ needs.seo-links.result }}"
          echo "a11y: ${{ needs.a11y.result }}"
          echo "sanity-schema: ${{ needs.sanity-schema.result }}"

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `
            ## CI Summary

            - code-quality: **${{ needs.code-quality.result }}**
            - code-consistency: **${{ needs.code-consistency.result }}**
            - format-check: **${{ needs.format-check.result }}**
            - security-audit: **${{ needs.security-audit.result }}**
            - build: **${{ needs.build.result }}**
            - seo-links: **${{ needs.seo-links.result }}**
            - a11y: **${{ needs.a11y.result }}**
            - sanity-schema: **${{ needs.sanity-schema.result }}**
            `;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });
